<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.w3.org/1999/xhtml"  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorator="layouts/default">
<head>
    <link rel="stylesheet" type="text/css" href="../static/common/css/source/custom/item.css" th:href="@{/common/css/source/custom/item.css}"/>
    <div sec:authorize="isAuthenticated()">
        <script src="../assets/common/js/custom/socket.js" th:src="@{/common/js/custom/socket.js}"></script>
    </div>
</head>
<th:block layout:fragment="content">
<section class="page-content">
    <div class="page-content-inner">

        <!-- Ecommerce Product Details -->
        <section class="panel panel-with-borders">
            <div class="panel-heading">
                <div class="pull-right">
                    <div class="dropdown">
                        <a href="javascript: void(0);"
                           data-toggle="dropdown" aria-expanded="false">
                            <i class="icmn-more2"></i>
                        </a>
                        <ul sec:authorize="isAuthenticated()" th:if="${#authentication.principal.id != user.id}" class="dropdown-menu dropdown-menu-right" aria-labelledby="" role="menu">
                            <a class="dropdown-item" data-toggle="modal" data-target="#modal-complaint" href="javascript:void(0)"><i class="dropdown-icon icmn-compass"></i> Denunciar este item</a>
                        </ul>
                        <ul sec:authorize="isAuthenticated()" th:if="${#authentication.principal.id == user.id}" class="dropdown-menu dropdown-menu-right" aria-labelledby="" role="menu">
                            <a class="dropdown-item" th:href="@{'/profile/items/' + ${item.id} + '/edit'}"><i class="dropdown-icon icmn-pencil"></i> Editar item</a>
                            <div class="dropdown-divider"></div>
                            <a id="delete-item" class="dropdown-item" href="javascript:void(0)" th:attr="data-id=${item.id}"><i class="dropdown-icon icmn-bin"></i> Eliminar item</a>
                        </ul>
                    </div>
                </div>
                <h2>
                    Detalle del Artículo
                </h2>
            </div>
            <div class="panel-body panel-profile">
                <div class="row">
                    <div class="col-lg-6 col-md-12 margin-left-20">
                        <div id="carousel-example-generic" class="carousel slide" data-ride="carousel">
                            <ol class="carousel-indicators">
                                <li data-target="#carousel-example-generic" data-slide-to="0" class="active"></li>
                                <li data-target="#carousel-example-generic" data-slide-to="1"></li>
                                <li data-target="#carousel-example-generic" data-slide-to="2"></li>
                            </ol>
                            <div class="carousel-inner item-height" role="listbox">
                                <div class="carousel-item active" align="center">
                                    <img class="item" th:src="${item.photo1}" alt="First slide"/>
                                </div>
                                <div class="carousel-item" align="center">
                                    <img class="item" th:src="${item.photo2}" alt="First slide"/>
                                </div>
                                <div class="carousel-item" align="center">
                                    <img class="item" th:src="${item.photo3}" alt="First slide"/>
                                </div>
                            </div>
                            <a class="left carousel-control" data-target="#carousel-example-generic" role="button" data-slide="prev">
                                <span class="icon-prev fa fa-arrow-left" aria-hidden="true"></span>
                                <span class="sr-only">Previous</span>
                            </a>
                            <a class="right carousel-control" data-target="#carousel-example-generic" role="button" data-slide="next">
                                <span class="icon-next fa fa-arrow-right" aria-hidden="true"></span>
                                <span class="sr-only">Next</span>
                            </a>
                        </div>
                    </div>
                    <div class="col-lg-5">
                        <div class="row">
                            <div class="col-sm-12 ">
                                <h3 th:text="${item.name}" class="cui-ecommerce--product--main-title"></h3>
                                <a class="avatar" th:href="@{'/users/' + ${user.username}}">
                                    <img th:src="${user.photo1}" />
                                </a>
                                <div class="user-wall-item-head">
                                <strong th:text="${user.name}"></strong>
                                </div>
                                <div class="cui-ecommerce--product--rating">
                                    <i class="icmn-star-full"></i>
                                    <i class="icmn-star-full"></i>
                                    <i class="icmn-star-full"></i>
                                    <i class="icmn-star-full"></i>
                                    <i class="icmn-star-empty"></i>
                                </div>
                            </div>
                        </div>
                        <hr />
                        <div class="row ">
                            <div class="col-lg-12">
                                <div class="cui-ecommerce--product--option_title">
                                    Categoría
                                </div>
                                <p th:text="${item.category.name}"></p>
                            </div>
                            <div class="col-lg-10">
                                <div class="cui-ecommerce--product--option_title">
                                    Características
                                </div>
                                <div class="cui-ecommerce--product--option well well-lg">
                                    <th:block th:each="tag : ${tags}">
                                        <span style="margin-top: 5px" class="label label-success" th:text="${tag.name}"></span>
                                    </th:block>
                                    <div th:if="${!hasTags}">
                                        <p>Parece que este objeto no posee tags por el momento!</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <hr />
                        <div sec:authorize="isAuthenticated()" th:if="${#authentication.principal.id != user.id}" style="padding: 40px">
                            <form id="form-trueque" action="/trueques" th:method="GET">
                                <input type="hidden" id="username-user-offerer" name="username-user-offerer" th:value="${#authentication.principal.username}"/>
                                <input type="hidden" id="username-user-demandant" name="username-user-demandant" th:value="${item.user.username}"/>
                                <button type="sumbit" id="btn-trueque" class="btn btn-icon btn-primary btn-lg margin-right-15 col-lg-offset-1">
                                    <i class="icmn-forward margin-right-5"></i>
                                    Trueque Ya
                                </button>
                            </form>
                        </div>
                        <div sec:authorize="isAnonymous()" style="padding: 40px">
                            <a href="/login"  class="btn btn-icon btn-primary btn-lg margin-right-15 col-lg-offset-1">
                                <i class="icmn-redo2 margin-right-5"></i>
                                Trueque ya
                            </a>
                        </div>

                        <div align="left" sec:authorize="isAuthenticated()" th:if="${#authentication.principal.id == user.id}" style="padding: 40px">
                            <a th:href="@{'/profile/items/' + ${item.id} + '/edit'}"  class="btn btn-icon btn-primary btn-lg margin-top-15">
                                <i class="icmn-forward margin-right-5 col-lg-offset-1"></i>
                                Editar
                            </a>
                        </div>
                    </div>

                    <div class="col-sm-12 margin-left-20">
                        <h3 class="cui-ecommerce--product--main-title">Descripción</h3>
                        <p th:text="${item.description}"></p>
                    </div>

                </div>
                <br/>

            </div>
        </section>


        <section class="panel  panel-with-borders" th:if="${sugerencias}">
            <div class="panel-heading">
                <h2>Productos Sugeridos</h2>

            </div>
            <div class="panel-body">
                <div class="cui-ecommerce--catalog">
                    <div class="row">
                        <div class="well well-lg">
                            <div class="cui-ecommerce--catalog--item">
                                <div class="cui-ecommerce--catalog--item--img">
                                    <div class="cui-ecommerce--catalog--item--like cui-ecommerce--catalog--item--like__selected">
                                        <i class="icmn-heart3 cui-ecommerce--catalog--item--like--liked"><!-- --></i>
                                        <i class="icmn-heart4 cui-ecommerce--catalog--item--like--unliked"><!-- --></i>
                                    </div>
                                    <a ref="#">
                                        <img src="https://image.ibb.co/dQCENQ/pava.jpg" />
                                    </a>
                                </div>
                                <div class="cui-ecommerce--catalog--item--title">
                                   Producto
                                </div>
                                <div class="cui-ecommerce--catalog--item--descr">
                                    Descripcion
                                    <div class="cui-ecommerce--catalog--item--descr--sizes">

                                    </div>

                                </div>
                            </div>
                        </div>

                        </div>
                    </div>
                </div>

        </section>

        <!-- End Ecommerce Product Details -->

    </div>
    <div class="modal fade"  id="modal-complaint" tabindex="-1" role="dialog" aria-labelledby="" aria-hidden="true" style="display: none;">
        <div class="modal-dialog" role="document">
            <form id="frm-complaint">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">×</span>
                        </button>
                        <h4 class="modal-title" id="myModalLabel">Denunciar</h4>
                    </div>
                    <div class="modal-body">
                        <div class="container">
                            <div class="row">
                                <div class="form-group col-sm-12">
                                    <label for="complaint-type">Tipo de Denuncia</label>
                                    <select id="complaint-type" class="form-control input-field" data-error=".errorTxt1">
                                        <option value="-1"> Seleccione tipo de denuncia</option>
                                        <option th:each="complaintType : ${complaintTypes}"
                                                th:value="${complaintType.id}" th:text="${complaintType.name}">                                                                </option>
                                    </select>
                                    <div class="errorTxt1"></div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="form-group col-sm-12">
                                    <label class="control-label">Motivo</label>
                                    <textarea id="description" class="form-control input-field" placeholder="Mensaje *" data-error=".errorTxt2"></textarea>
                                    <div class="errorTxt2"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn" data-dismiss="modal">Cerrar</button>
                        <button id="btn-complaint" type="button" class="btn btn-primary">Enviar</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Page Scripts -->
    <script src="../static/vendors/datatables-responsive/js/dataTables.responsive.js"
            th:src="@{/vendors/owl.carousel/dist/owl.carousel.js}"></script>
    <script th:inline="javascript">
        /*<![CDATA[*/
        let token = [[${_csrf.token}]];
        let header = [[${_csrf.headerName}]];
        let username = [[${user.username}]];

        $('.owl-carousel').owlCarousel({
            loop:true,
            margin:10,
            nav:true,
            responsive:{
                0:{
                    items:1
                },
                600:{
                    items:3
                },
                1000:{
                    items:5
                }
            }
        });

        let getComplaint = function(){
            let complaint = {
                complaintType: {
                    id: $('#complaint-type').val()
                },
                description: $('#description').val()
            };
            return complaint;
        };

        $(document).ready(function(){
            $('#delete-item').on('click', function(){
                var itemId = $(this).data('id');

                swal({
                    title: "¿Estás seguro?",
                    text: "Estás a punto de eliminar éste item",
                    icon: "warning",
                    buttons: true,
                    dangerMode: true
                })
                    .then((willDelete) => {
                        if (willDelete) {

                            $.ajax({
                                type: 'DELETE',
                                url: '/profile/items/' + itemId,
                                contentType: 'application/json',
                                beforeSend: function (xhr) {
                                    xhr.setRequestHeader(header, token);
                                },
                                success: function (data) {
                                    if(data){
                                        swal("Item Eliminado", "Item eliminado con éxito", "success");
                                        window.location.href = "/profile";
                                    }else{
                                        swal("No es posible eliminar", "El item se encuentra en un trueque en proceso", "error");
                                    }
                                },
                                error: function (e) {
                                    console.log(e);
                                }
                            });
                        }
                    });

            });

            $('#btn-complaint').on('click', function () {
                let complaint = getComplaint();
                var l = Ladda.create(this);
                l.start();
                $.ajax({
                    type: "POST",
                    url: "/users/complaints/" + username,
                    contentType : "application/json",
                    data: JSON.stringify(complaint),
                    beforeSend: function (xhr) {
                        xhr.setRequestHeader(header, token);
                    },
                    success: function (data) {
                        l.stop();
                        $('#modal-complaint').modal('toggle');
                        swal("Denuncia enviada", "Nuestro equipo se encargará de aquí en adelante", "success");
                    },
                    error: function (e) {
                        console.log(e);
                    }
                });
            });
        });
        /*]]>*/
    </script>

<!-- End Page Scripts -->
</section>

</th:block>
</html>