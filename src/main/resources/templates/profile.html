<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.w3.org/1999/xhtml"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" xmlns:dt="http://www.w3.org/1999/xhtml"
      layout:decorator="layouts/default">
<head>
    <link rel="stylesheet" type="text/css" href="../static/common/css/source/custom/profile.css" th:href="@{/common/css/source/custom/profile.css}"/>
    <!-- MagicSuggest -->
    <link rel="stylesheet" type="text/css" th:href="@{/vendors/dropify/dist/css/dropify.min.css}"/>
    <link th:href="@{/vendors/magicsuggest/magicsuggest-min.css}" href="../static/vendors/magicsuggest/magicsuggest-min.css" rel="stylesheet"/>
    <script th:src="@{/vendors/dropify/dist/js/dropify.min.js}" src="../assets/vendors/dropify/dist/js/dropify.min.js"></script>
    <script th:src="@{/vendors/magicsuggest/magicsuggest-min.js}" src="../static/vendors/magicsuggest/magicsuggest-min.js"></script>
    <script th:src="@{/common/js/custom/magicSuggest.js}" src="../static/common/js/custom/magicSuggest.js"></script>
    <script src="../assets/common/js/custom/socket.js" th:src="@{/common/js/custom/socket.js}"></script>
    <!--VALIDATIONS-->
    <script th:src="@{/common/js/custom/formValidator.js}" src="../static/common/js/custom/formValidator.js"></script>

</head>
<th:block layout:fragment="content">
<section class="page-content">
<div class="page-content-inner">

    <!-- Profile Header -->
    <nav class="top-submenu top-submenu-with-background">
        <div class="profile-header">
            <div class="profile-header-info">
                <div class="row">
                    <div class="col-xl-8 col-xl-offset-4">
                    <!-- Esto todavia no lo saco porque se cae el nombre, podria ser reemplazado por un boton que lleve a los items -->
                        <div th:if="${hasScore}" class="width-100 text-center pull-right hidden-md-down">
                            <h2><span class="label label-success" th:text="${user.score}">8,2</span></h2>
                            <div class="cui-ecommerce--product--rating stars">
                                <!--Las estrellas se agregan por javascript-->
                            </div>
                        </div>
                        <div class="profile-header-title">
                            <h2 th:text="${'Bienvenido ' + user.name}"></h2>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>
    <!-- End Profile Header -->

    <!-- Profile -->
    <div class="row">
        <div class="col-xl-4">
            <section class="panel profile-user background-img">
                <div class="panel-body">
                    <div class="profile-user-title text-center">
                        <a class="avatar" href="javascript:void(0);">
                            <img th:src="${user.photo1}"/>
                        </a>
                        <div class="cui-ecommerce--product--rating stars">
                            <!--Las estrellas se agregan por javascript-->
                        </div>
                        <br/>
                    </div>
                </div>
            </section>
            <section class="panel panel-profile">
                <div class="panel-body">
                    <h6>Información personal</h6>
                    <br/>
                    <input id="userId" type="hidden" th:field="${user.id}" />
                    <dl class="dl-horizontal user-profile-dl">
                        <dt>Nombre Completo</dt>
                        <dd th:text="${user.name + ' ' + user.last_name}">Nombre</dd>
                        <dt>Nombre de Usuario</dt>
                        <dd th:text="${user.username}">Username</dd>
                        <dt>Email</dt>
                        <dd th:text="${user.email}">Email</dd>
                        <dt>Tags</dt>
                        <dd th:if="${hasTags}"><span th:each="tag : ${tags}" class="label label-default tag-margin" th:text="${tag.name}">Tag</span></dd>
                        <dd th:if="${!hasTags}">Parece que no has actualizado tus tags.</dd>
                    </dl>
                    <a href="/profile/edit"><button class="btn btn-primary" type="button">Editar</button></a>
                </div>
            </section>
        </div>
        <div class="col-xl-8">
            <section class="panel panel-profile profile-user-content">
                <div class="panel-body">
                    <div class="nav-tabs-horizontal">
                        <ul class="nav nav-tabs" role="tablist">
                            <li class="nav-item">
                                <a class="nav-link active" id="link-item" href="javascript: void(0);" data-toggle="tab" data-target="#posts" role="tab">
                                    <i class="icmn-menu3"></i>
                                    Items
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" id="link-trueque" href="javascript: void(0);" data-toggle="tab" data-target="#messaging" role="tab">
                                    <i class="icmn-image-compare"></i>
                                    Trueques
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" id="link-comment" data-toggle="tab" data-target="#comments" role="tab">
                                    <i class="icmn-info"></i>
                                    Comentarios
                                </a>
                            </li>

                            <div th:if="${hasItems}" >
                            <li style="float: right" class="nav-item">
                                <button id="new-item" type="button" class="btn btn-icon btn-info margin-inline">
                                    <i class="icmn-plus2" aria-hidden="true"></i>
                                </button>
                            </li>
                            </div>
                        </ul>
                        <div class="tab-content padding-vertical-20 active">
                            <div th:if="${hasItems}" class="tab-pane active" id="posts" role="tabpanel">
                                <div class="row">
                                    <div class="col-lg-12">
                                        <div class="margin-bottom-50">
                                            <table class="table table-hover nowrap" id="tbl-items" width="100%">
                                                <thead>
                                                <tr>
                                                    <th>Imagen</th>
                                                    <th>Nombre</th>
                                                    <th>Categoria</th>
                                                    <th>Estado</th>
                                                </tr>
                                                </thead>
                                                <tbody>
                                                <tr  th:each="item : ${items}">
                                                    <td><a th:href="'/profile/items/' + ${item.id}">
                                                        <img width="100px" th:src="${item.photo1}"/>
                                                    </a></td>
                                                    <td><a th:href="'/profile/items/' + ${item.id}" class="link-underlined"><span
                                                            th:text="${item.name}"></span></a></td>
                                                    <td th:text="${item.category.name}">Categoria</td>
                                                    <td><span class="label label-info" th:text="${item.getStatusValue()}">Estado</span></td>
                                                </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                                <div th:if="${itemsCount > #lists.size(items)}" th:with="result=${itemsCount - #lists.size(items)}">
                                    <a th:href="@{/items(search=${'@'+user.username})}" class="btn btn-default width-full" th:text="${'Ver Más (' + result + ')'}">Ver Más</a>
                                </div>
                            </div>
                            <div th:if="${!hasItems}" class="tab-pane active" id="posts" role="tabpanel">
                                Parece que aún no tienes items.
                                <a id="manito" data-toggle="modal" data-target="#modalCreateItem">
                                    Click acá para agregar uno!
                                </a>
                            </div>
                            <div  class="tab-pane" id="messaging" role="tabpanel">
                                <div   th:if="${hasTrueques}" class="tab-pane active"  role="tabpanel">
                                    <div class="row">
                                        <div class="col-lg-12">
                                            <div class="margin-bottom-50">
                                                <table class="table table-hover nowrap" id="tbl-trueques" width="100%">
                                                    <thead>
                                                    <tr>
                                                        <th>Fecha de Propuesta</th>
                                                        <th>Participantes</th>
                                                        <th>Estado</th>
                                                        <th>Acciones</th>
                                                        <th>Realizado con</th>
                                                    </tr>
                                                    </thead>
                                                    <tbody>
                                                    <tr th:id="${'trueque-'+ut.id.trueque.id}" th:each="ut : ${userTrueques}" th:if="${#authentication.principal.id == ut.id.user.id}">
                                                        <td th:text="${#dates.format(ut.id.trueque.proposalDate, 'dd-MM-yyyy')}"></td>
                                                          <td th:text="${ut.id.trueque.peopleCount}"></td>
                                                        <td><span class="label label-info" th:text="${ut.id.trueque.getStatusValue()}"></span></td>
                                                        <td th:id="${'actions-'+ut.id.trueque.id}">
                                                            <div th:if="${ut.showActions}">
                                                                <div th:if="${ut.id.trueque.isPendiente()}">
                                                                    <a th:href="@{'/trueques/'+${ut.id.trueque.id}+'/user/'+ ${user.username} +'/accept'}" class="btn btn-xs btn-success">
                                                                        <i class="fa fa-check" aria-hidden="true"></i> Aceptar
                                                                    </a>
                                                                    <a th:href="'/profile/trueques/' + ${ut.id.trueque.id}" class="btn btn-xs">
                                                                        <i class="fa fa-bars" aria-hidden="true"></i> Detalle
                                                                    </a>
                                                                    <button type="button" class="btn btn-xs btn-danger cancel" th:attr="data-id=${ut.id.trueque.id}">Rechazar</button>
                                                                </div>
                                                                <div th:if="${ut.id.trueque.isActivo()}">
                                                                    <button type="button" class="btn btn-xs btn-success confirm" th:attr="data-id=${ut.id.trueque.id}">Confirmar</button>
                                                                    <button type="button" class="btn btn-xs btn-danger cancel" th:attr="data-id=${ut.id.trueque.id}">Cancelar</button>
                                                                    <a th:href="'/profile/trueques/' + ${ut.id.trueque.id}" class="btn btn-xs">
                                                                        <i class="fa fa-bars" aria-hidden="true"></i> Detalle
                                                                    </a>
                                                                </div>
                                                            </div>
                                                            <div th:if="${!ut.showActions}">
                                                                Esperando a los demás usuarios!
                                                                <a th:href="'/profile/trueques/' + ${ut.id.trueque.id}" class="btn btn-xs">
                                                                    <i class="fa fa-bars" aria-hidden="true"></i> Detalle
                                                                </a>
                                                            </div>
                                                        </td>

                                                              <td>
                                                                  <div th:if="${ut.id.trueque.peopleCount == 2}"  th:each="utt : ${userTrueques}">
                                                                      <div th:if="${utt.id.trueque.id == ut.id.trueque.id and utt.id.user.id != ut.id.user.id}">
                                                                          <div th:text="${utt.id.user.name + ' ' + utt.id.user.last_name}">
                                                                          </div>
                                                                      </div>
                                                                  </div>
                                                                  <div th:if="${ut.id.trueque.peopleCount == 3}" th:each="utt : ${userTrueques}">
                                                                      <div th:if="${utt.id.trueque.id == ut.id.trueque.id and utt.id.user.id != ut.id.user.id}">
                                                                          <div th:if="${utt.id.user.id != #authentication.principal.id}">
                                                                             <div th:text="${utt.id.user.name + ' ' + utt.id.user.last_name}">
                                                                             </div>
                                                                          </div>
                                                                      </div>
                                                                  </div>
                                                              </td>
                                                    </tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div th:if="${!hasTrueques}" class="tab-pane active" id="messaging" role="tabpanel">
                                    Parece que aún no has realizado ningún trueque!
                                </div>
                            </div>



                            <div class="tab-pane" id="comments" role="tabpanel">
                                <div class="tab-pane active"  role="tabpanel">
                                    <div class="row">
                                        <div class="col-lg-12">
                                            <div class="margin-bottom-50 container">
                                                <div th:if="${hasComments}">
                                                    <div id="comments-wall" class="user-wall">
                                                        <div class="user-wall-item clearfix" th:each="comment : ${comments}">
                                                            <div class="s1">
                                                                <a class="avatar" th:href="@{'/users/' + ${comment.userOrigin.username}}" >
                                                                    <img th:src="${comment.userOrigin.photo1}" />
                                                                </a>
                                                            </div>
                                                            <div class="s2">
                                                                <div class="user-wall-item-head">
                                                                    <div class="pull-right">
                                                                        <a th:attr="data-username=${comment.userOrigin.username}" class="userTarget"><i class="icmn-compass"></i></a>
                                                                    </div>
                                                                    <strong th:text="${comment.userOrigin.name}">Name</strong>
                                                                    <small th:text="${#dates.format(comment.date,'dd-MM-yyyy HH:mm')}"></small>
                                                                </div>
                                                                <div class="user-wall-post">
                                                                    <p th:text="${comment.description}">Comentario</p>
                                                                </div>
                                                                <div class="user-wall-controls">
                                                                    <div class="cui-ecommerce--product--rating">
                                                                        <i class="icmn-star-full" th:each="i : ${#numbers.sequence( 1, comment.score/2)}"></i>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div th:if="${!comments.last}">
                                                            <a id="comments-more" href="javascript: void(0);" th:attr="data-number=${comments.number}" class="btn btn-default width-full ladda-button" data-style="zoom-in">Ver Más</a>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div th:if="${!hasComments}">
                                                    <p th:text="${'Parece que no hay comentarios sobre ' + user.name + ' por el momento'}"></p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </div>
    <!-- End Profile -->
</div>

    <!--MODAL CREATE ITEM-->
    <div class="modal fade" id="modalCreateItem" tabindex="-1" role="dialog" aria-labelledby="" aria-hidden="true" style="display: none;">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">×</span>
                    </button>
                    <h4 class="modal-title" id="myModalLabel">Nuevo Item</h4>
                </div>

                <form id="newItemForm" th:action="@{'/profile/items'}" th:object="${item}" th:method="POST" enctype="multipart/form-data">

                    <div class="modal-body">
                        <div class="col-lg">
                            <div class="row">
                                <div class="col-lg-6">
                                    <div class="form-group">
                                        <label class="control-label">Nombre</label>
                                        <input id="itemName" type="text" th:field="*{name}" class="form-control col-lg-12"/>
                                    </div>
                                </div>
                                <div class="col-lg-6">
                                    <!--DROP DOWN LIST DE CATEGORIA-->
                                    <div class="form-group">
                                        <label for="selectCat" class="form-control-label">Categoría</label>
                                        <select th:field="*{category}" id="selectCat" class="form-control">
                                            <option value="-1"> Seleccione categoría</option>
                                            <option th:each="cat : ${categories}" th:value="${cat.id}"
                                                    th:text="${cat.name}" th:field="*{category}"></option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-lg-12">
                                    <div class="form-group">
                                        <label for="descTextArea" class="form-control-label">Descripción</label>
                                        <textarea th:field="*{description}" id="descTextArea" class="form-control" rows="4"></textarea>
                                    </div>
                                </div>
                            </div>

                            <h5>Etiquetas</h5>
                            <div class="form-group">
                                <label for="ms" class="form-control-label">Escribe aquí palabras relacionadas con tu item:</label>
                                <input id="ms" type="text" class="form-control tagsinput" />
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button id="btnCerrar" type="button" class="btn" data-dismiss="modal">Cerrar</button>
                            <button id="submit-btn" type="button" class="btn btn-primary ladda-button" data-style="zoom-in">Guardar</button>
                        </div>
                    </div>

                </form>
            </div>
        </div>
    </div>
    <!--END MODAL CREATE ITEM-->

    <!--MODAL SET IMAGES-->
    <div class="modal fade" id="modalSetImages" tabindex="-1" role="dialog" aria-labelledby="" aria-hidden="true" style="display: none; overflow-y: scroll;">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">×</span>
                    </button>
                    <h4 class="modal-title">Agregue imágenes a su item</h4>
                </div>

                <form id="form-set-images" action="/profile/items/images" th:method="POST" enctype="multipart/form-data">
                    <!--<input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>-->
                    <input id="itemId" type="hidden" name="id"/>
                    <div class="modal-body">
                        <div class="col-lg">
                            <h5>Fotos del Item</h5>
                            <input id="photo1" type="file" class="dropify" name="pictures" accept="image/*" data-max-file-size="2M" />
                            <br/>
                            <input id="photo2" type="file" class="dropify" name="pictures" accept="image/*" data-max-file-size="2M" />
                            <br/>
                            <input id="photo3" type="file" class="dropify" name="pictures" accept="image/*" data-max-file-size="2M" />
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn" data-dismiss="modal">Cerrar</button>
                            <button id="submitImages" type="button"  class="btn btn-primary">Enviar</button>
                        </div>
                    </div>

                </form>
            </div>
        </div>
    </div>
    <!--END MODAL SET IMAGES-->

    <!--MESSAGES MODAL-->
    <div class="modal fade" id="messageModal" data-color="red" tabindex="-1" role="dialog" aria-labelledby="" aria-hidden="true"
         style=" vertical-align: middle; z-index: 3000;">
        <div class="modal-dialog" role="document">
            <div class="modal-content" style="background-color: #ced5d8">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">×</span>
                    </button>
                    <h4 class="modal-title">Aviso</h4>
                </div>
                <div class="modal-body">
                    <span id="messageSpan"></span>
                </div>
                <div class="modal-footer">
                    <button type="button" data-dismiss="modal" class="btn btn-primary">Aceptar</button>
                </div>
            </div>
        </div>
    </div>
    <!--END MESSAGES MODAL-->

    <!--MODAL SET COMMENTS-->
    <div class="modal fade"  id="modalCreateComment" tabindex="-1" role="dialog" aria-labelledby="" aria-hidden="true" style="display: none;">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 id="modal-name" class="modal-title"></h4>
                </div>
                <div class="modal-body">
                    <div class="container">
                        <input type="hidden" id="idUser" name="userTarget"/>
                        <div class="form-group">
                            <div class="col-lg">
                                <div class="row">
                                    <div class="form-group">
                                        <label for="commentDescription" class="form-control-label">Comentario</label>
                                        <textarea id="commentDescription" class="form-control" rows="4"></textarea>
                                    </div>
                                    <div class="form-group">
                                        <label for="scoreComboBox" class="form-control-label">¿Como calificarías al usuario?</label>
                                        <select class="form-control" id="scoreComboBox" name="score">
                                            <option value="-1">Seleccionar</option>
                                            <option value="2">Malo</option>
                                            <option value="4">Regular</option>
                                            <option value="6">Bueno</option>
                                            <option value="8">Muy bueno</option>
                                            <option value="10">Excelente</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button id="sendComment" type="button"  class="btn btn-primary s">Enviar</button>
                    <button type="button" class="btn" data-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>
    <!--END MODAL SET COMMENT-->

    <!--MODAL TRUEQUE QUESTION-->
    <div class="modal fade"  id="modalCreateQuestion" tabindex="-1" role="dialog" aria-labelledby="" aria-hidden="true" style="display: none;">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title">No olvides actualizar el estado de tus trueques!</h4>
                </div>
                <div class="modal-body">
                    <div class="container">
                        <div class="form-group">
                            <div class="col-lg">
                                <div class="row">
                                    <div class="form-group">
                                        <label for="commentDescription" class="form-control-label">Notamos que tienes algunos activos hace mas de 7 días con las siguientes personas</label>
                                        <ul id="trueques-pending"></ul>
                                    </div>
                                </div>
                            </div>
                            <button  type="button" class="btn btn-xs btn-danger" data-dismiss="modal">Cerrar</button>
                            <a id="verTruequesBtn" class="btn btn-xs">
                                <i class="fa fa-bars" aria-hidden="true"></i> Ver Tus Trueques
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!--END MODAL QUESTION-->

    <!-- MODAL COMPLAINT -->
    <div class="modal fade"  id="modal-complaint" tabindex="-1" role="dialog" aria-labelledby="" aria-hidden="true" style="display: none;">
        <div class="modal-dialog" role="document">
            <form id="frm-complaint">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">×</span>
                        </button>
                        <h4 class="modal-title">Denunciar</h4>
                    </div>
                    <div class="modal-body">
                        <div class="container">
                            <div class="row">
                                <div class="form-group col-sm-12">
                                    <label for="complaint-type">Tipo de Denuncia</label>
                                    <select id="complaint-type" class="form-control input-field" data-error=".errorTxt1">
                                        <option value="-1"> Seleccione tipo de denuncia</option>
                                        <option th:each="complaintType : ${complaintTypes}"
                                                th:value="${complaintType.id}" th:text="${complaintType.name}">                                                                </option>
                                    </select>
                                    <div class="errorTxt1"></div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="form-group col-sm-12">
                                    <label class="control-label">Motivo</label>
                                    <textarea id="description" class="form-control input-field" placeholder="Mensaje *" data-error=".errorTxt2"></textarea>
                                    <div class="errorTxt2"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn" data-dismiss="modal">Cerrar</button>
                        <button id="btn-complaint" type="button" class="btn btn-primary">Enviar</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    <!-- END MODAL COMPLAINT -->


<!-- Page Scripts -->
    <script th:inline="javascript">
        /*<![CDATA[*/
        var x = 0;
        var users = [];
        var userId= /*[[${#authentication.principal.id}]]*/ "";



        $(document).ready(function(){
            $.ajax({
                type: 'GET',
                url: 'profile/trueques/ask',
                contentType: 'application/json',
//                beforeSend: function (xhr) {
//                    xhr.setRequestHeader(header, token);
//                },
                success: function (data) {
                    console.log(data)
                    if(data!=false){
                        console.log(data)
                        usersTrueque = data;
                         makeQuestion(usersTrueque);
                    }
                },
                error: function (e) {
                    console.log(e);
                }
            });


            $('#verTruequesBtn').on('click', function () {

                document.getElementById('posts').setAttribute('class','tab-pane');
                document.getElementById('messaging').setAttribute('class','tab-pane active');
                document.getElementById('link-comment').setAttribute('class','nav-link');
                document.getElementById('link-item').setAttribute('class','nav-link');
                document.getElementById('link-trueque').setAttribute('class','nav-link active');


                $('#modalCreateQuestion').modal('hide');


            });


            $('.cancel').on('click', function(){
                var truequeId = $(this).data('id');

                swal({
                    title: "¿Estás seguro?",
                    text: "Una vez cancelado, no podrás continuar con esta propuesta de trueque",
                    icon: "warning",
                    buttons: true,
                    dangerMode: true
                })
                    .then((willDelete) => {
                        if (willDelete) {
                            $(this).parent().parent().parent().parent().fadeOut(500, function(){
                                $(this).remove();
                            });
                            $.ajax({
                                type: 'POST',
                                url: 'profile/trueques/' + truequeId,
                                contentType: 'application/json',
                                success: function (data) {
                                    if(data){
                                        users = data;
                                        x=0;
                                        makeComment(data[x]);
                                    }
                                    else{
                                        swal("Trueque Rechazado", "Esta propuesta de trueque ha sido correctamente rechazada", "success");
                                    }
                                },
                                error: function (e) {
                                    console.log(e);
                                }
                            });
                        }
                    });

            });

            $('#tbl-items').DataTable({
                responsive: true,
                searching: false,
                lengthChange: false,
                info: false,
                paging: false
            });
            $('#tbl-trueques').DataTable({
                responsive: true,
                searching: false,
                lengthChange: false,
                info: false,
                paging: false,
                aaSorting: []
            });
            $('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
                $($.fn.dataTable.tables(true)).DataTable()
                    .columns.adjust()
                    .responsive.recalc();
            });




            $('.confirm').on('click', function(){
                var truequeId = $(this).data('id');
                var btn = $(this);
                swal({
                    title: "¿El trueque se ha realizado con exito?",
                    text: "¿Se ha llevado a cabo el intercambio de objetos con exito?",
                    buttons: true,

                })
                    .then((willDelete) => {
                        if (willDelete) {
                            btn.parent().parent().remove();
                            $('#actions-' + truequeId).append('Esperando a los demás usuarios!\n' +
                                '<a href="/profile/trueques/'+ truequeId +'" class="btn btn-xs">\n' +
                                '<i class="fa fa-bars" aria-hidden="true"></i> Detalle\n' +
                                '</a>');
                            $.ajax({
                                type: 'POST',
                                url: 'profile/trueques/' + truequeId + '/confirm/',
                                contentType: 'application/json',
                                success: function (map) {
                                    if(map.ready){
                                        $('#trueque-' + truequeId).fadeOut(500, function(){ $(this).remove(); })
                                    }
                                    if(map.users){
                                        users = map.users;
                                        x=0;
                                        makeComment(map.users[x]);
                                    }else{
                                        swal("Trueque Confirmado", "Este trueque ha sido correctamente confirmado", "success");
                                    }

                                },
                                error: function (e) {
                                    console.log(e);
                                }
                            });
                        }
                    });
            });

            $('#sendComment').on('click', function(){
                if(isValidated('commentModal')){
                    sendComment();
                }

            });
        });

        makeQuestion = function(usersTrueque){
            var ul = $("#trueques-pending");
            ul.html("");
            $("#commentDescription").val("");
            $('#modalCreateQuestion').modal('show');
            usersTrueque.forEach(function(userT){
                if (userId != userT.id.user.id){
                    let userTNode = document.createElement("LI");
                    userTNode.appendChild(document.createTextNode(userT.id.user.name));
                    ul.append(userTNode);
                }
            });

        };

        makeComment = function(user){
            $("#commentDescription").val("");
            $('#modalCreateComment').modal('show');
            $('#modal-name').text('¿Te gustaría dejar un comentario acerca de ' + user.name + '?');
            $('#idUser').val(user.id);
            x ++;
        };

        function getNewComment(){
            let commentDescription = $("#commentDescription").val();
            let idUser = $("#idUser").val();
            let scoreValue = $('#scoreComboBox').val();
            var comment = {
                description: commentDescription,
                userTarget: {id: idUser},
                score: scoreValue
            };
            return JSON.stringify(comment);
        }

        sendComment = function () {
            $.ajax({
                type: "POST",
                url: "profile/comment",
                contentType: "application/json",
                data: getNewComment(),
                dataType: "json",
                success: function (data) {
                    swal("Comentario Enviado", "Nuestro equipo se encargará de aquí en adelante", "success");
                    checkMoreComments();

                },
                error: function (e) {
                    console.log(e);
                }
            });
        };

        checkMoreComments = function(){
            if (x < users.length){
                makeComment(users[x]);
            }else{
                $('#modalCreateComment').modal('hide');
            }
        };

        $(function() {
            $('.dropify').dropify();
        });

        /*]]>*/
    </script>

    <script th:inline="javascript">
        /*<![CDATA[*/
        var score = [[${user.score}]]/2;
        var username = [[${user.username}]];
        var page = [[${comments}]];
        var userTarget;

        var i;
        for(i = 0; i < score; i++){
            $('.stars').append('<i class="icmn-star-full"></i>');
        }
        for(i; i < 5; i++){
            $('.stars').append('<i class="icmn-star-empty"></i>');
        }

        var getComplaint = function(){
            let complaint = {
                complaintType: {
                    id: $('#complaint-type').val()
                },
                description: $('#description').val()
            };
            return complaint;
        };

        displayComments = function(page){
          let wall = $('#comments-wall');
          let btnVerMas = $('#comments-more');

          //Borro los eventos para denuncias y Ver mas
          btnVerMas.off('click');
          $('.userTarget').off('click');
            let aux = btnVerMas.data('number');
            aux += 1;
            btnVerMas.attr('data-number', aux);
          btnVerMas.remove();

          //Muestro comentarios
          page.content.forEach(function(comment){
              let date = new Date(comment.date);
              wall.append(
                  '<div class="user-wall-item clearfix">' +
                  '<div class="s1">' +
                  '<a class="avatar" href="/users/'+ comment.userOrigin.username +'">' +
                  '<img src="'+ comment.userOrigin.photo1 +'" />' +
                  '</a>' +
                  '</div>' +
                  '<div class="s2">' +
                  '<div class="user-wall-item-head">' +
                  '<div class="pull-right">' +
                  '<a class="userTarget" data-username="'+ comment.userOrigin.username +'"><i class="icmn-compass"></i></a>' +
                  '</div>' +
                  '<strong>'+ comment.userOrigin.name +'</strong>' +
                  '<small>'+ (date.getMonth()+1) + '-' + date.getDate() + '-' + date.getFullYear() + ' ' + date.getHours() + ':' + date.getMinutes() + '</small>' +
                  '</div>' +
                  '<div class="user-wall-post">' +
                  '<p>'+ comment.description +'</p>' +
                  '</div>' +
                  '<div class="user-wall-controls">' +
                  '<div id="stars-' + comment.id + '" class="cui-ecommerce--product--rating">' +
                  '</div>' +
                  '</div>' +
                  '</div>' +
                  '</div>'
              );
              let stars = comment.score/2;
              for (i = 0; i < stars; i++) {
                  $('#stars-' + comment.id + '').append(
                      '<i class="icmn-star-full"></i>'
                  );
              }
          });

            //Seteo los evento para denuncias y Ver mas si corresponde
            $('.userTarget').on('click', function () {
                userTarget = $(this).data('username');
                $('#modal-complaint').modal('show');
            });
            if(!page.last){
                wall.append(btnVerMas);
                $('#comments-more').on('click', function(){
                    let number = $(this).data('number');
                    getComments(number);
                });
            }
        };

        getComments = function(number){
            $.ajax({
                type: 'GET',
                url: 'profile/comments/paginated',
                data: {
                    "page": number +1,
                },
                success: function (data) {
                    console.log(data);
                    displayComments(data);
                },
                error: function (e) {
                    console.log(e);
                }
            });
        };

    $(document).ready(function () {

        $('.userTarget').on('click', function () {
            userTarget = $(this).data('username');
            $('#modal-complaint').modal('show');
        });

        $('#btn-complaint').on('click', function () {
            if(isValidated('frm-complaint')){
                var l = Ladda.create(this);
                l.start();
                let complaint = getComplaint();
                $.ajax({
                    type: "POST",
                    url: "/users/complaints/" + userTarget,
                    contentType : "application/json",
                    data: JSON.stringify(complaint),
                    success: function (data) {
                        l.stop();
                        $('#modal-complaint').modal('toggle');
                        swal("Denuncia enviada", "Nuestro equipo se encargará de aquí en adelante", "success");
                    },
                    error: function (e) {
                        console.log(e);
                    }
                });
            }
        });

        $('#comments-more').on('click', function(){
            let number = $(this).data('number');
            getComments(number);
        });

    });
        /*]]>*/
    </script>

    <script th:inline="javascript">
        /*<![CDATA[*/
        var ms;

        $('#new-item').click(function(){
            $('#modalCreateItem').modal('show');
        });

        function getNewItem(){
            let itemName = $("#itemName").val();
            let itemDes = $("#descTextArea").val();
            let user = $("#user").val();
            let itemCat = $("#selectCat").val();
            var item = {
                name: itemName,
                user: {id: user},
                description: itemDes,
                category: {id: itemCat},
                tags: ms.getSelection()
            };
            return JSON.stringify(item);
        }

        document.addEventListener("DOMContentLoaded", function () {
            ms.initialize();
            $("#submit-btn").on("click", function () {
            if (isValidated('newItemForm')){
                var l = Ladda.create(this);
                l.start();

                $.ajax({
                    type: "POST",
                    url: "/profile/items",
                    contentType : "application/json",
                    data: getNewItem(),
                    dataType : 'json',
//                    beforeSend: function (xhr) {
//                        xhr.setRequestHeader(header, token);
//                    },
                    success: function (data) {
                        l.stop();
                        $("#modalCreateItem").modal('hide');
                        $('#itemId').val(data.id);
                        $('#modalSetImages').modal('show');
                    },
                    error: function (e) {
                        console.log(e);
                    }
                });

                }
            });

            //VALIDACION DE IMAGENES
            $("#submitImages").on("click", function () {
               if(isValidated('form-set-images')){
                   $("#form-set-images").submit();
                   $("#modalSetImages").modal('hide');
               }
            });

            $("#btnCerrar").on("click", function () {
                $("#modalCreateItem").modal('hide');
            })

        });
        /*]]>*/
    </script>


<!-- End Page Scripts -->
</section>
<div class="main-backdrop"><!-- --></div>

</th:block>
</html>